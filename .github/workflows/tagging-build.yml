name: build

on:
  workflow_call:
    inputs:
      delete-list-files:
        type: string
        default: ""
      suffixe:
        type: string
        default: ""
      prerelease:
        type: boolean
        default: false
      branch_name:
        type: string
        required: true
      github_repository:
        type: string
        required: true

jobs:
  tagger-build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—³ï¸ Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{inputs.branch_name}}

      - name: ğŸ» Obtener version de composer
        id: version-composer-current
        run: |
          VERSION=$(grep -m1 version composer.json | awk -F: '{ print $2 }' | sed 's/[", ]//g')
          cat composer.json
          echo "::set-output name=value::$VERSION"

      - name: ğŸ”‘ VER VERSION
        run: echo ${{steps.version-composer-current.outputs.value}}

      - name: ğŸ”‘ AUMENTAR VERSION
        id: version-composer-now
        run: |
          CURRENT_VERSION=${{steps.version-composer-current.outputs.value}}
          EXPLODE_VERSION=( ${CURRENT_VERSION//./ } )
          ((EXPLODE_VERSION[2]++))
          VERSION_NOW="${EXPLODE_VERSION[0]}.${EXPLODE_VERSION[1]}.${EXPLODE_VERSION[2]}"
          echo "::set-output name=value::$VERSION_NOW"

      - name: ğŸ”‘ VER VERSION
        run: echo ${{steps.version-composer-now.outputs.value}}
        
      - name: ğŸ”‘ Cambiamos version
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          sed -i -e "s/\"version\":.*/\"version\": ${{steps.version-composer-now.outputs.value}}/g" composer.json
          git add composer.json
          git commit -m "[skip ci] Nueva version"
          git remote add origin https://${{ secrets.GITHUB_TOKEN }}@github.com/${{inputs.github_repository}}
          git push

#       - name: ğŸ”‘ Permisos
#         run: make permissions

#       - name: ğŸ—‘ï¸ Eliminamos residuos
#         run: for f in ${{inputs.delete-list-files}}; do rm -rf $f; done

#       - name: ğŸ“š Comprimimos
#         run: zip -r ${{steps.version-composer.outputs.value}}${{inputs.suffixe}}.zip .

#       - name: ğŸ—‘ï¸ Eliminar release
#         uses: dev-drprasad/delete-tag-and-release@v0.2.0
#         with:
#           delete_release: true
#           tag_name: ${{steps.version-composer.outputs.value}}${{inputs.suffixe}}
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#       - name: ğŸš€ Crear release
#         uses: actions/create-release@v1
#         with:
#           draft: false
#           prerelease: ${{inputs.prerelease}}
#           release_name: ${{steps.version-composer.outputs.value}}${{inputs.suffixe}}
#           tag_name: ${{steps.version-composer.outputs.value}}${{inputs.suffixe}}
#         env:
#           GITHUB_TOKEN: ${{ github.token }}

#       - name: â˜ï¸ Subiendo release
#         uses: AButler/upload-release-assets@v2.0
#         with:
#           files: '${{steps.version-composer.outputs.value}}${{inputs.suffixe}}.zip'
#           release-tag: ${{steps.version-composer.outputs.value}}${{inputs.suffixe}}
#           repo-token: ${{ secrets.GITHUB_TOKEN }}
